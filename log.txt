ðŸ» Brandons-MBP.lan default ~/Documents/code/exoflow/apps/autobutler-home/infra/ansible $ ansible-playbook -i inventory/hosts playbooks/setup_k3s_cluster.yml --ask-pass -vv                          ansible-playbook -i inventory/hosts playbooks/setup_k3s_cluster.yml --ask-pass -vv
ansible-playbook [core 2.18.4]
  config file = None
  configured module search path = ['/Users/brandonapol/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /opt/homebrew/Cellar/ansible/11.4.0/libexec/lib/python3.13/site-packages/ansible
  ansible collection location = /Users/brandonapol/.ansible/collections:/usr/share/ansible/collections
  executable location = /opt/homebrew/bin/ansible-playbook
  python version = 3.13.2 (main, Feb  4 2025, 14:51:09) [Clang 16.0.0 (clang-1600.0.26.6)] (/opt/homebrew/Cellar/ansible/11.4.0/libexec/bin/python)
  jinja version = 3.1.6
  libyaml = True
No config file found; using defaults
SSH password: 
redirecting (type: modules) ansible.builtin.authorized_key to ansible.posix.authorized_key
Skipping callback 'default', as we already have a stdout callback.
Skipping callback 'minimal', as we already have a stdout callback.
Skipping callback 'oneline', as we already have a stdout callback.

PLAYBOOK: setup_k3s_cluster.yml ****************************************************************************
5 plays in playbooks/setup_k3s_cluster.yml
Enter sudo password: 

PLAY [Get sudo password] ***********************************************************************************

TASK [Set fact for sudo password] **************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_k3s_cluster.yml:10
ok: [localhost -> pi1(192.168.1.126)] => (item=pi1) => {"ansible_facts": {"ansible_become_pass": "asdfasdf"}, "ansible_loop_var": "item", "changed": false, "item": "pi1"}
ok: [localhost -> pi2(192.168.1.182)] => (item=pi2) => {"ansible_facts": {"ansible_become_pass": "asdfasdf"}, "ansible_loop_var": "item", "changed": false, "item": "pi2"}

PLAY [Setup k3s cluster with custom CA] ********************************************************************

TASK [Ensure SSH key is present on all nodes] **************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_k3s_cluster.yml:27
redirecting (type: modules) ansible.builtin.authorized_key to ansible.posix.authorized_key
redirecting (type: modules) ansible.builtin.authorized_key to ansible.posix.authorized_key
redirecting (type: modules) ansible.builtin.authorized_key to ansible.posix.authorized_key
redirecting (type: modules) ansible.builtin.authorized_key to ansible.posix.authorized_key
ok: [pi2] => {"changed": false, "comment": null, "exclusive": false, "follow": false, "key": "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJ03EfznOmRSwxBm5z6Q3jSx5XNeFFTAMErWREDYbuhZ brandonapol@cedarville.edu", "key_options": null, "keyfile": "/home/brandonapol/.ssh/authorized_keys", "manage_dir": true, "path": null, "state": "present", "user": "brandonapol", "validate_certs": true}
ok: [pi1] => {"changed": false, "comment": null, "exclusive": false, "follow": false, "key": "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJ03EfznOmRSwxBm5z6Q3jSx5XNeFFTAMErWREDYbuhZ brandonapol@cedarville.edu", "key_options": null, "keyfile": "/home/brandonapol/.ssh/authorized_keys", "manage_dir": true, "path": null, "state": "present", "user": "brandonapol", "validate_certs": true}

PLAY [Uninstall k3s] ***************************************************************************************

TASK [Gathering Facts] *************************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/uninstall_k3s.yml:2
ok: [pi2]
ok: [pi1]

TASK [Stop k3s service] ************************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/uninstall_k3s.yml:9
fatal: [pi2]: FAILED! => {"changed": false, "msg": "Could not find the requested service k3s-agent: host"}
...ignoring
fatal: [pi1]: FAILED! => {"changed": false, "msg": "Could not find the requested service k3s-agent: host"}
...ignoring

TASK [Uninstall k3s] ***************************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/uninstall_k3s.yml:14
fatal: [pi2]: FAILED! => {"changed": true, "cmd": "/usr/local/bin/k3s-uninstall.sh", "delta": "0:00:00.005589", "end": "2025-04-04 23:11:40.331739", "msg": "non-zero return code", "rc": 127, "start": "2025-04-04 23:11:40.326150", "stderr": "/bin/sh: 1: /usr/local/bin/k3s-uninstall.sh: not found", "stderr_lines": ["/bin/sh: 1: /usr/local/bin/k3s-uninstall.sh: not found"], "stdout": "", "stdout_lines": []}
...ignoring
fatal: [pi1]: FAILED! => {"changed": true, "cmd": "/usr/local/bin/k3s-uninstall.sh", "delta": "0:00:00.014982", "end": "2025-04-04 23:11:40.880940", "msg": "non-zero return code", "rc": 127, "start": "2025-04-04 23:11:40.865958", "stderr": "/bin/sh: 1: /usr/local/bin/k3s-uninstall.sh: not found", "stderr_lines": ["/bin/sh: 1: /usr/local/bin/k3s-uninstall.sh: not found"], "stdout": "", "stdout_lines": []}
...ignoring

TASK [Clean up k3s directories] ****************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/uninstall_k3s.yml:19
changed: [pi2] => (item=/etc/rancher/k3s) => {"ansible_loop_var": "item", "changed": true, "item": "/etc/rancher/k3s", "path": "/etc/rancher/k3s", "state": "absent"}
ok: [pi1] => (item=/etc/rancher/k3s) => {"ansible_loop_var": "item", "changed": false, "item": "/etc/rancher/k3s", "path": "/etc/rancher/k3s", "state": "absent"}
ok: [pi2] => (item=/var/lib/rancher/k3s) => {"ansible_loop_var": "item", "changed": false, "item": "/var/lib/rancher/k3s", "path": "/var/lib/rancher/k3s", "state": "absent"}
ok: [pi2] => (item=/var/lib/cni) => {"ansible_loop_var": "item", "changed": false, "item": "/var/lib/cni", "path": "/var/lib/cni", "state": "absent"}
ok: [pi2] => (item=/opt/cni) => {"ansible_loop_var": "item", "changed": false, "item": "/opt/cni", "path": "/opt/cni", "state": "absent"}
ok: [pi1] => (item=/var/lib/rancher/k3s) => {"ansible_loop_var": "item", "changed": false, "item": "/var/lib/rancher/k3s", "path": "/var/lib/rancher/k3s", "state": "absent"}
changed: [pi2] => (item=/var/lib/kubelet) => {"ansible_loop_var": "item", "changed": true, "item": "/var/lib/kubelet", "path": "/var/lib/kubelet", "state": "absent"}
ok: [pi2] => (item=/var/lib/etcd) => {"ansible_loop_var": "item", "changed": false, "item": "/var/lib/etcd", "path": "/var/lib/etcd", "state": "absent"}
ok: [pi1] => (item=/var/lib/cni) => {"ansible_loop_var": "item", "changed": false, "item": "/var/lib/cni", "path": "/var/lib/cni", "state": "absent"}
ok: [pi1] => (item=/opt/cni) => {"ansible_loop_var": "item", "changed": false, "item": "/opt/cni", "path": "/opt/cni", "state": "absent"}
ok: [pi1] => (item=/var/lib/kubelet) => {"ansible_loop_var": "item", "changed": false, "item": "/var/lib/kubelet", "path": "/var/lib/kubelet", "state": "absent"}
ok: [pi1] => (item=/var/lib/etcd) => {"ansible_loop_var": "item", "changed": false, "item": "/var/lib/etcd", "path": "/var/lib/etcd", "state": "absent"}

TASK [Remove k3s binaries and scripts] *********************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/uninstall_k3s.yml:31
ok: [pi2] => (item=/usr/local/bin/k3s) => {"ansible_loop_var": "item", "changed": false, "item": "/usr/local/bin/k3s", "path": "/usr/local/bin/k3s", "state": "absent"}
ok: [pi2] => (item=/usr/local/bin/k3s-uninstall.sh) => {"ansible_loop_var": "item", "changed": false, "item": "/usr/local/bin/k3s-uninstall.sh", "path": "/usr/local/bin/k3s-uninstall.sh", "state": "absent"}
ok: [pi1] => (item=/usr/local/bin/k3s) => {"ansible_loop_var": "item", "changed": false, "item": "/usr/local/bin/k3s", "path": "/usr/local/bin/k3s", "state": "absent"}
ok: [pi2] => (item=/usr/local/bin/k3s-killall.sh) => {"ansible_loop_var": "item", "changed": false, "item": "/usr/local/bin/k3s-killall.sh", "path": "/usr/local/bin/k3s-killall.sh", "state": "absent"}
ok: [pi2] => (item=/tmp/k3s-install.sh) => {"ansible_loop_var": "item", "changed": false, "item": "/tmp/k3s-install.sh", "path": "/tmp/k3s-install.sh", "state": "absent"}
ok: [pi1] => (item=/usr/local/bin/k3s-uninstall.sh) => {"ansible_loop_var": "item", "changed": false, "item": "/usr/local/bin/k3s-uninstall.sh", "path": "/usr/local/bin/k3s-uninstall.sh", "state": "absent"}
ok: [pi1] => (item=/usr/local/bin/k3s-killall.sh) => {"ansible_loop_var": "item", "changed": false, "item": "/usr/local/bin/k3s-killall.sh", "path": "/usr/local/bin/k3s-killall.sh", "state": "absent"}
ok: [pi1] => (item=/tmp/k3s-install.sh) => {"ansible_loop_var": "item", "changed": false, "item": "/tmp/k3s-install.sh", "path": "/tmp/k3s-install.sh", "state": "absent"}

TASK [Remove k3s systemd service] **************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/uninstall_k3s.yml:41
ok: [pi2] => (item=/etc/systemd/system/k3s.service) => {"ansible_loop_var": "item", "changed": false, "item": "/etc/systemd/system/k3s.service", "path": "/etc/systemd/system/k3s.service", "state": "absent"}
ok: [pi2] => (item=/etc/systemd/system/k3s-agent.service) => {"ansible_loop_var": "item", "changed": false, "item": "/etc/systemd/system/k3s-agent.service", "path": "/etc/systemd/system/k3s-agent.service", "state": "absent"}
ok: [pi1] => (item=/etc/systemd/system/k3s.service) => {"ansible_loop_var": "item", "changed": false, "item": "/etc/systemd/system/k3s.service", "path": "/etc/systemd/system/k3s.service", "state": "absent"}
ok: [pi1] => (item=/etc/systemd/system/k3s-agent.service) => {"ansible_loop_var": "item", "changed": false, "item": "/etc/systemd/system/k3s-agent.service", "path": "/etc/systemd/system/k3s-agent.service", "state": "absent"}

TASK [Reload systemd daemon] *******************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/uninstall_k3s.yml:49
ok: [pi2] => {"changed": false, "name": null, "status": {}}
ok: [pi1] => {"changed": false, "name": null, "status": {}}

TASK [Display uninstallation status] ***********************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/uninstall_k3s.yml:53
ok: [pi1] => {
    "msg": "K3s has been uninstalled from pi1"
}
ok: [pi2] => {
    "msg": "K3s has been uninstalled from pi2"
}

PLAY [Setup CA and certificates for k3s] *******************************************************************

TASK [Gathering Facts] *************************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:2
ok: [pi2]
ok: [pi1]

TASK [Create CA directory] *********************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:17
skipping: [pi1] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}
skipping: [pi2] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}

TASK [Generate CA private key] *****************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:23
skipping: [pi1] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}
skipping: [pi2] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}

TASK [Generate CA certificate] *****************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:30
skipping: [pi1] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}
skipping: [pi2] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}

TASK [Generate server private key] *************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:40
skipping: [pi1] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}
skipping: [pi2] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}

TASK [Generate server CSR] *********************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:47
skipping: [pi1] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}
skipping: [pi2] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}

TASK [Create SANs configuration file] **********************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:54
skipping: [pi1] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}
skipping: [pi2] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}

TASK [Generate server certificate] *************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:62
skipping: [pi1] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}
skipping: [pi2] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}

TASK [Generate client private key] *************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:75
skipping: [pi1] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}
skipping: [pi2] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}

TASK [Generate client CSR] *********************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:82
skipping: [pi1] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}
skipping: [pi2] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}

TASK [Generate client certificate] *************************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:88
skipping: [pi1] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}
skipping: [pi2] => {"changed": false, "false_condition": "inventory_hostname == 'butler0'", "skip_reason": "Conditional result was False"}

TASK [Create cert directories on worker nodes] *************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:100
changed: [pi2] => {"changed": true, "gid": 0, "group": "root", "mode": "0755", "owner": "root", "path": "/etc/rancher/k3s/certs", "size": 4096, "state": "directory", "uid": 0}
changed: [pi1] => {"changed": true, "gid": 0, "group": "root", "mode": "0755", "owner": "root", "path": "/etc/rancher/k3s/certs", "size": 4096, "state": "directory", "uid": 0}

TASK [Copy CA certificate to worker nodes] *****************************************************************
task path: /Users/brandonapol/Documents/code/exoflow/apps/autobutler-home/infra/ansible/playbooks/setup_ca.yml:106
fatal: [pi2]: FAILED! => {"changed": false, "msg": "Source /etc/rancher/k3s/certs/ca.crt not found"}
fatal: [pi1]: FAILED! => {"changed": false, "msg": "Source /etc/rancher/k3s/certs/ca.crt not found"}

PLAY RECAP *************************************************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
pi1                        : ok=11   changed=2    unreachable=0    failed=1    skipped=10   rescued=0    ignored=2   
pi2                        : ok=11   changed=3    unreachable=0    failed=1    skipped=10   rescued=0    ignored=2   
